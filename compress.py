'''
Created on 07.01.2015

@author: dddsnn
'''

import bitstring as bs

def order_enc(bits, sample_len):
    if len(bits) % sample_len:
        raise ValueError('Input not divisible by sample length')
    res = bs.BitStream()
    num_samples = len(bits) // sample_len
    for i in range(sample_len):
        for s in range(num_samples):
            pos = s * sample_len + i
            res += bits[pos:pos + 1]
    return res

def order_dec(bits, sample_len):
    if len(bits) % sample_len:
        raise ValueError('Input not divisible by sample length')
    res = bs.BitStream()
    num_samples = len(bits) // sample_len
    for s in range(num_samples):
        for i in range(sample_len):
            pos = i * num_samples + s
            res += bits[pos:pos + 1]
    return res

def mtf_enc(bits):
    res = bs.BitStream()
    last = False
    for b in bits:
        if b == last:
            res += bs.Bits('0b0')
        else:
            res += bs.Bits('0b1')
            last = b
    return res

def mtf_dec(bits):
    res = bs.BitStream()
    last = bs.BitStream('0b0')
    for b in bits:
        if b == True:
            last.invert()
        res += last
    return res

def rl_enc(bits):
    def write_zeros():
        nonlocal res
        res += bs.Bits('0b0')
        x = bs.Bits(ue=zero_count)
        res += x
    res = bs.BitStream()
    zero_count = 0
    for b in bits:
        if b:
            # write zeros first
            if zero_count:
                write_zeros()
                zero_count = 0
            # just write 1's normally, they're rare
            res += bs.Bits('0b1')
        else:
            zero_count += 1
    # write any remaining zeros
    if zero_count:
        write_zeros()
    return res

def rl_dec(bits):
    res = bs.BitStream()
    while bits.pos != bits.len:
        b = bits.read('bits:1')
        if b[0]:
            res += b
        else:
            num_zeros = bits.read('ue')
            res += bs.Bits(num_zeros)
    return res

def compress(bits, sample_len):
    reordered = order_enc(bits, sample_len)
    mtfed = mtf_enc(reordered)
    return rl_enc(mtfed)

def decompress(bits, sample_len):
    rl_decoded = rl_dec(bits)
    un_mtfed = mtf_dec(rl_decoded)
    return order_dec(un_mtfed, sample_len)

if __name__ == '__main__':
    # example data, 60 seconds of hl2 at 20 samples/sec and 13 different keys
    ex_data1 = bs.Bits('0b000100010001000010001000100001000100010000100010000000010000000000001000000000000100000100000010000010000000000001000000000000100001000000010000100000001000010000000100000000000010000000000001000000000000100000000000010000000000001000000000000100000000000010000000000001000000000000100000000000010000000000001000000100000100000010000010000001000000000000100000000000010001000000000000100000000000010000000000001000000000000100000000000010000000000001000000010000100000001000010000000100000000000010000000000001000000100000100000010000010000001000001000000100000100000010000010000001000001000000001000100000000100010000000000001000000000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010001000100001000000010000000000001000000000000100000000000010000000000001000000000000100000000000010000000000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000000010001000000001000100000000100010000000000001000000100000100000010000010000001000001000000100000100000010000010000001000001000000100000100010010000010001001000001000000100000100000010000010000001000001000000100001100000010000110000001000011000000100000100000010000010000001000001000000100000100000010000010000001000001000000100000100000010000010000001000001000000100000100000011000010000001100001000000110000100000010000010000001000001000000100000100000010000010000001000001000000100000100000010000010000001000001000000100000100000010000010000001000001000000100000100000010000010000001000001000000100000100000010000010000000000001000000000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000000000001000000000000100000000000010000000000001000000100000100000010000010000001000001000000100000100000010000000000001000000000000100000000000010000000000001000000000000100000000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000000000001000000000000100000010000010000101000001000010100000100001010000010000101000001000010100000100001010000010000101000001000010100000100001010000010000101000001000010100000100001010000010000101000001000010100000100001010000010000101000001000010100000100001010000010000001000001000000100000100000010000010000001000001000000100000100000010000010000001000001000000100000100000010000010000001000001000010100000100001010000011000101000001100010100000110001010000010000101000001000010100000100001010000010000101000001000010100000100001010000010000101000001000010100000100001010000010000101000001000010100000110000010000011000001000001100000100000100000010000010000001000001000000100000100000010000010000001001001000000100100100000010000010000001000001000000100000100000010000010000001000001000000100000100000010000010000001000001000000100000100000010000010000001000001000000100000100000010000010000001000001000000100000100000010000010000001000001000000100000100000010000010000001000001000000000000100000000000010000000000001100000000000110000000000011000000000001000000000000100000000000010000000000001000000000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000000000000100000000000010000000000001000001000000100000100000010000010000001000001000000100000100000010000010000001000001000000100000100000010000010000001000001000000100000100000010000010000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100000100000010000011000001000001100000000000110000000000011000000000001100000000000110000000000011000100000001100010000000100001000000010000100000001000010001000100001000100010000100010001000010001000100001000100010000100010001000010001000100001000100010000100010001000010001000100001000100010000100010001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000100010000100010001000010001000100001000100010000100010000000010001000000001000100000000100010000000010001000000001000100000000100010001000010001000100001000100010000100010001000010000000100001000000010000100000001000010000000100001000100010000100010001000010001000100001000100010000100010001000010001000100001000100010000100010000100010001000010001000100001000100010000100010001000010001000100001000100000000100010000000010001000000001000100010000100010001000010001000100001000100010000100010001000010001000100001000100010000100010001000010001000100001000100010000100010001000010001000100001000100010000100010001000010001000100001000100000000100010000000010001000100001000100010000100010001000010001000100001000100010000100010001000010001000100001000100010000100010000000010001000000001000100000000100010000000010001000000001000100000000100010000000010001000100001000100010000100010001000010001000100001000100010000100010001000010001000100001000100010000100010001000010001000100001000100010000100010000000010001000000001000100000000100010000000010001000000001000100000000100010000000010000000000001000000000000100000000000010000000000001000100000000100010000000010001000000001000000000000100000000000010000010000001000001000000000000100000000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000000000001000000100000100000010001010000001000101000000100010100000000001010000000000101000000000010100000000001010000000000101000000000010101000000001010100000000101010000000010101000000001010100000000101010000000010101000000001010100000000101000000000010100000000001010000000000101000000000010100000010001010000001000001000000100000100000010000010000001000001000000100000100000010000010000001000001100000100000110000010000011000001000001000000000000100000000000010000000000001000001000000100000100000010000010000001000001000000100000100000010000010000001000001000000100000100000010000010000001000001000000100000100000010000010000000000001000000000000100000000000010000001000001000000100000100000010000010000001000001000000100000100000010000010000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100000110000010000011000001000001100000100000110000010000011000001000001100000100000110000010000011000001000001100000100000110000010000011000001000001100000100000110000010000010000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000010000001000001100000100000110000010000011000001000001100000100000110000010000011000001000001100000100000110000010000011000001000001100000100000110000010000011000001000001100000100000110000010000011000001000011100000100001110000010000111000001000011100000100001110000010000111000001000011100000100001110000010000111000001000011100000100001110000010000111000001000011100000100001110000010000111000001000011100000100001110000010000011000001000001100000100000110000010000011000001000001100000100000110000010000011000001000011100000100001110000010000111000001000011100000100001110000010000111000011000011100001100001110000110000111000011000011100001100001110000010000111000001000011100000100001110000010000111000001000011100000100001110000010000111000001000011100000100001110000010000111000001000011100000100001110000010000111000001000011100000100001110000010000111000001000011100000100001110000010000111000001000011100000100001110000010000111000001000011100000100000110000010000011000001000001100000100000110000010000011000001000001100000100000110000010000011000001000001100000100000110000010000001000001000000100000100000100000010000010000001000001000000100000100000000000010000000000001000000000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100000000000010000000000001000000100000100000010000010000001000001000000100000000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100000010000010000001000001000000100000100000100000010000010000001000001000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000010000001000001100000100000110000010000011000001000001100000100000110000010000011000001000001100000100000110000010000011000001000001000000100000100000010000010000001000001000000100000100000010000010000001000001000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100001100000010000110000001000011000000100000100000010000010000001000001000000100000100000010000011000001000001100000100000110000010000011000001000001100000100000110000010000011000001000001100000100000110000010000011000001000001100000100000110000010000010000001000001000000100000100000010000010000001000001000000100000100000010000010000001000001000000100000100000010000010000001000001000000100000110000010000001000001000000100000100000010000010000001000001000000100000100000010000010000001000001000000100000100000010000010000001000001000000000000100000000000010000000000001000001000000100000100000010000010000001000001000000000000100000000000010000100000001000010000000000001000000000000100000000100010000000010001000000001000100000000100010000000010001000000001000100000000100010000000010001000000001000100000000100010000000010001000000001000100000000100010000000010001000000001000100000000100000000000010000000000001000001000000100000100000000000010000000000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100000000000000000000000100000000000010000000000001000000000000100000000000010000000000001000000010000100000001000010001000100001000100010000100010001000010001000100001000100010000100010001000010001000100001000100010000100010001000010001000000001000100001000100010000100010001000010001000100001000100010000100010001000010001000100001000100010000100010001000010001000100001000100010000100010001000010001000000001000100000000100010000000010001000100001000100010000100010001000010001000100001000100010000100010001000010001000100001000100010000100010001000010001000000001000100000000100010001000010001000100001000100010000100010001000010001000100000000100000000000010000000000001000000001000100000000100010000000010001000000001000100000000100010000000010001000000001000100000000100010000000000001000000000000100000000000010000100000001000010000000100000000000010000000000001000000000000100001000000010000100000001000000000000100000000000010000000000001000000010000100001001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100010001000010001000000001000100000000100000000000010000000000001000000000000100000000000010000000000001000100000000100010001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000000000001000000000000100000010000010000001000001000000100000100000010000010000001000001000000100000100000010000010001001000001000000100000100000010000010000001000001000000110000100000011000010000001100001000000100000100000010000010000001000000000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000000000000100000000000010000000000001000000100000100000010000010000001000001000000000000100000000000010000000000001000000000000100000000000010000000000001000000000000100000000000010000000000001000000100000100000010000010000001000001000000100000100000010000010000000000001000000000000100000000000010000000000001000000000000101000000000010000000000001000000000000100000000000010100000000001000000000000100000010000010100001000001010000100000100000010000010000001000001000000100000100000010000010000001000000000000100000000000010000000000001000000000000100000000000010000010100001000001010000100000101000010000010000001000001000000100000100000010000010000001000001000000100000100000010000010000001000001000000100000100000000000010000000000001000000000000100000000000010000000000001000000000000100000000000010000000000001000000000000100000000000010000000000001000000000000100000000000010000000000001000000000000100000000000010000000000001000000000000100000000000010000000000001000000000000100000000000010000000000001000000000000100000000000010000000000001000000000000100000000000010000000000001000000000000100000000000010000000000001000000000000100000000000010000000000001000000000000100000000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000010000000100001000000010000100000001000')
    compressed1 = compress(ex_data1, 13)
    print('full length:')
    print('in length: {0}'.format(len(ex_data1)))
    print('compressed length: {0}'.format(len(compressed1)))
    print('ratio: {0}'.format(len(compressed1) / len(ex_data1)))
    print('decompresses correctly: {0}'
          .format(decompress(compressed1, 13) == ex_data1))
    print()
    ex_data1_short = ex_data1[:260]
    compressed1_short = compress(ex_data1_short, 13)
    print('only using the first 20 samples:')
    print('in length: {0}'.format(len(ex_data1_short)))
    print('compressed length: {0}'.format(len(compressed1_short)))
    print('ratio: {0}'.format(len(compressed1_short) / len(ex_data1_short)))
    print('decompresses correctly: {0}'
          .format(decompress(compressed1_short, 13) == ex_data1_short))
